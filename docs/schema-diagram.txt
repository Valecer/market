
Database Schema: Data Ingestion Infrastructure
==============================================

┌─────────────────────────────────────────────────────────────┐
│                        SUPPLIERS                            │
├─────────────────────────────────────────────────────────────┤
│ id (UUID, PK)                                               │
│ name (VARCHAR(255), NOT NULL, INDEX)                        │
│ source_type (VARCHAR(50), NOT NULL, INDEX)                  │
│   CHECK: source_type IN ('google_sheets', 'csv', 'excel')  │
│ contact_email (VARCHAR(255), NULL)                           │
│ metadata (JSONB, NOT NULL, DEFAULT '{}')                    │
│ created_at (TIMESTAMP, NOT NULL)                            │
│ updated_at (TIMESTAMP, NOT NULL)                             │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ 1:N (CASCADE DELETE)
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                     SUPPLIER_ITEMS                          │
├─────────────────────────────────────────────────────────────┤
│ id (UUID, PK)                                               │
│ supplier_id (UUID, FK → suppliers.id, NOT NULL, INDEX)      │
│ product_id (UUID, FK → products.id, NULL, INDEX)             │
│ supplier_sku (VARCHAR(255), NOT NULL)                       │
│ name (VARCHAR(500), NOT NULL)                               │
│ current_price (NUMERIC(10,2), NOT NULL, INDEX)               │
│   CHECK: current_price >= 0                                 │
│ characteristics (JSONB, NOT NULL, DEFAULT '{}', GIN INDEX)  │
│ last_ingested_at (TIMESTAMP, NOT NULL, INDEX DESC)          │
│ created_at (TIMESTAMP, NOT NULL)                            │
│ updated_at (TIMESTAMP, NOT NULL)                            │
│ UNIQUE(supplier_id, supplier_sku)                          │
└───────┬───────────────────────────────┬─────────────────────┘
        │                               │
        │ 1:N (CASCADE DELETE)          │ N:1 (SET NULL)
        │                               │
        ▼                               ▼
┌──────────────────────────┐  ┌──────────────────────────────┐
│     PRICE_HISTORY         │  │         PRODUCTS               │
├──────────────────────────┤  ├──────────────────────────────┤
│ id (UUID, PK)            │  │ id (UUID, PK)                 │
│ supplier_item_id (UUID,  │  │ internal_sku (VARCHAR(100),   │
│   FK → supplier_items.id,│  │   UNIQUE, NOT NULL, INDEX)    │
│   NOT NULL, INDEX)       │  │ name (VARCHAR(500), NOT NULL,  │
│ price (NUMERIC(10,2),    │  │   INDEX)                       │
│   NOT NULL)              │  │ category_id (UUID, FK →        │
│   CHECK: price >= 0      │  │   categories.id, NULL, INDEX)  │
│ recorded_at (TIMESTAMP,   │  │ status (ENUM, NOT NULL,        │
│   NOT NULL, INDEX DESC)  │  │   DEFAULT 'draft', INDEX)      │
│                          │  │   VALUES: draft/active/archived│
└──────────────────────────┘  │ created_at (TIMESTAMP)        │
                              │ updated_at (TIMESTAMP)          │
                              └──────────────┬─────────────────┘
                                             │
                                             │ N:1 (SET NULL)
                                             │
                                             ▼
                              ┌──────────────────────────────┐
                              │        CATEGORIES              │
                              ├──────────────────────────────┤
                              │ id (UUID, PK)                 │
                              │ name (VARCHAR(255), NOT NULL)  │
                              │ parent_id (UUID, FK →         │
                              │   categories.id, NULL, INDEX) │
                              │   (Self-referential)           │
                              │ created_at (TIMESTAMP)         │
                              │ UNIQUE(name, parent_id)        │
                              └──────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                      PARSING_LOGS                           │
├─────────────────────────────────────────────────────────────┤
│ id (UUID, PK)                                               │
│ task_id (VARCHAR(255), NOT NULL, INDEX)                      │
│ supplier_id (UUID, FK → suppliers.id, NULL, INDEX)           │
│   ON DELETE SET NULL                                         │
│ error_type (VARCHAR(100), NOT NULL, INDEX)                   │
│ error_message (TEXT, NOT NULL)                               │
│ row_number (INTEGER, NULL)                                   │
│ row_data (JSONB, NULL)                                       │
│ created_at (TIMESTAMP, NOT NULL, INDEX DESC)                 │
└─────────────────────────────────────────────────────────────┘

Key Relationships:
------------------
1. Supplier → SupplierItems (1:N, CASCADE DELETE)
   - Deleting a supplier deletes all its items

2. SupplierItem → PriceHistory (1:N, CASCADE DELETE)
   - Deleting a supplier item deletes its price history

3. Product → SupplierItems (1:N, SET NULL)
   - Deleting a product sets supplier_items.product_id to NULL

4. Category → Products (1:N, SET NULL)
   - Deleting a category sets products.category_id to NULL

5. Category → Categories (Self-referential, CASCADE DELETE)
   - Deleting a parent category deletes all child categories

6. Supplier → ParsingLogs (1:N, SET NULL)
   - Deleting a supplier sets parsing_logs.supplier_id to NULL

Key Indexes:
------------
- GIN index on supplier_items.characteristics (JSONB queries)
- Composite unique index on (supplier_id, supplier_sku)
- Descending indexes on timestamp columns for chronological queries
- Indexes on foreign keys for join performance
